<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">test/index.js | redash-client</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Redash API Client for JavaScript"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="redash-client"><meta property="twitter:description" content="Redash API Client for JavaScript"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/teppeis/redash-client"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/RedashClient.js~RedashClient.html">RedashClient</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">test/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

const Client = require(&apos;../&apos;);
const assert = require(&apos;assert&apos;);
const Mock = require(&apos;axios-mock-adapter&apos;);

require(&apos;axios-debug-log&apos;);

/** @test {RedashClient} */
describe(&apos;RedashClient&apos;, () =&gt; {
  it(&apos;should be a constructor&apos;, () =&gt; {
    const client = new Client();
    assert(client instanceof Client);
  });

  describe(&apos;api&apos;, () =&gt; {
    let client, mock;

    beforeEach(() =&gt; {
      client = new Client({
        endPoint: &apos;https://demo.redash.io/&apos;,
        apiToken: process.env.API_TOKEN || &apos;abc123&apos;,
      });
      mock = new Mock(client.axios_);
    });

    /** @test {RedashClient#getQuery} */
    it(&apos;getQuery&apos;, async () =&gt; {
      const expectedBody = require(&apos;./fixtures/get-query&apos;);

      const {id} = expectedBody;
      mock.onGet(`/api/queries/${id}`).reply(200, expectedBody);
      const actual = await client.getQuery(id);
      assert.deepEqual(actual, expectedBody);
    });

    /** @test {RedashClient#postQuery} */
    it(&apos;postQuery with max_age = 0&apos;, async () =&gt; {
      const expectedBody = require(&apos;./fixtures/post-query_results-max_age_0&apos;);

      mock.onPost(&apos;/api/query_results&apos;).reply(200, expectedBody);
      const actual = await client.postQuery({
        query: &apos;select * from cohort2&apos;,
        data_source_id: 2,
        max_age: 0,
      });
      assert.deepEqual(actual, expectedBody);
    });

    /** @test {RedashClient#getJob} */
    it(&apos;getJob&apos;, async () =&gt; {
      const expectedBody = require(&apos;./fixtures/get-jobs-1&apos;);

      const {id} = expectedBody.job;
      mock.onGet(`/api/jobs/${id}`).reply(200, expectedBody);
      const actual = await client.getJob(id);
      assert.deepEqual(actual, expectedBody);
    });

    /** @test {RedashClient#getQueryResult} */
    it(&apos;getQueryResult&apos;, async () =&gt; {
      const expectedBody = require(&apos;./fixtures/get-query_results&apos;);

      const {id} = expectedBody.query_result;
      mock.onGet(`/api/query_results/${id}`).reply(200, expectedBody);
      const actual = await client.getQueryResult(id);
      assert.deepEqual(actual, expectedBody);
    });

    /** @test {RedashClient#queryAndWaitResult} */
    it(&apos;queryAndWaitResult&apos;, async () =&gt; {
      const job1 = require(&apos;./fixtures/post-query_results-max_age_0&apos;);
      const job2 = require(&apos;./fixtures/get-jobs-2&apos;);
      const job3 = require(&apos;./fixtures/get-jobs-3&apos;);
      const queryResult = require(&apos;./fixtures/get-query_results&apos;);

      const jobId = job1.job.id;
      const queryResultId = job3.job.query_result_id;
      mock.onPost(&apos;/api/query_results&apos;).reply(200, job1);
      mock.onGet(`/api/jobs/${jobId}`).replyOnce(200, job2);
      mock.onGet(`/api/jobs/${jobId}`).replyOnce(200, job3);
      mock.onGet(`/api/query_results/${queryResultId}`).reply(200, queryResult);

      const actual = await client.queryAndWaitResult({
        query: &apos;select * from cohort2&apos;,
        data_source_id: 2,
        max_age: 0,
      });
      assert.deepEqual(actual, queryResult);
    });

    /** @test {RedashClient#queryAndWaitResult} */
    it(&apos;queryAndWaitResult: timeout&apos;, function(done) {
      this.timeout(3000);

      const job1 = require(&apos;./fixtures/post-query_results-max_age_0&apos;);
      const job2 = require(&apos;./fixtures/get-jobs-2&apos;);

      const jobId = job1.job.id;
      mock.onPost(&apos;/api/query_results&apos;).reply(200, job1);
      mock.onGet(`/api/jobs/${jobId}`).reply(200, job2);

      client.queryAndWaitResult({
        query: &apos;select * from cohort2&apos;,
        data_source_id: 2,
        max_age: 0,
      }, 1000).catch(e =&gt; {
        assert(/polling timeout/.test(e.message));
        done();
      });
    });
  });
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
